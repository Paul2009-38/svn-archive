# This is a start for an (almost) cut'n past installation description for mapnik-osm-renderer

# ------ Install some stuff
sudo apt-get install build-essential libfreetype6-dev libltdl3-dev \
                libpng12-dev  libtiff4-dev libboost-thread-dev libboost-filesystem-dev \
                libboost-serialization-dev libboost-regex-dev libboost-python-dev \
                libboost-program-options-dev proj python-imaging scons \
                postgresql-8.1 postgresql-8.1-plruby postgresql-8.1-postgis \
                postgresql-client-8.1 postgresql-contrib-8.1 postgresql-doc-8.1 \
                postgresql-plperl-8.1 postgresql-plpython-8.1 \
                postgresql-server-dev-8.1 \
                libboost-python-dev python2.4-dev \
		libwww-perl libxml-parser-perl libfile-slurp-perl libtimedate-perl libdate-manip-perl

# ---- Install mapnik
  cd
  svn co svn://svn.berlios.de/mapnik/trunk mapnik 
  cd mapnik
  python scons/scons.py
  sudo python scons/scons.py install
  sudo python scons/scons.py PGSQL_INCLUDES=/usr/include/postgresql \
       PGSQL_LIBS=/usr/lib/postgresql/8.1/lib install

# ---- Install and run planet-mirror --> planet.sql
  cd
  svn co http://svn.openstreetmap.org/
  # compile UTF8sanitize
  ( cd svn.openstreetmap.org/utils/planet.osm/C; make)
  # Get newest planet.osm. This will takes some time
  svn.openstreetmap.org/utils/planet-mirror/planet-mirror.pl -v
  bunzip2 --keep `svn.openstreetmap.org/utils/planet-mirror/planet-mirror.pl -print-filename`
  export planet_name=`svn.openstreetmap.org/utils/planet-mirror/planet-mirror.pl -print-filename`
  echo "Planet File: $planet_name"
  # compile osmsql
  (cd svn.openstreetmap.org/utils/osm2pgsql/; make)
  # convert osm --> sql. takes about 15 minutes on a 3GHz Machine
  date; time ~/svn.openstreetmap.org/utils/osm2pgsql/osm2pgsql $planet_name > $planet_name.sql


# ----------- As User Postgres
su - postgres
createdb -Upostgres  -EUTF8 gis
createuser -Upostgres -S -D -R osm
echo "GRANT ALL ON SCHEMA PUBLIC TO osm;" | psql -Upostgres gis
createlang plpgsql gis
psql -Upostgres gis </usr/share/postgresql-8.1-postgis/lwpostgis.sql \
     2>&1 | grep -v -e 'FEHLER:  aktuelle Transaktion' \
     -e 'ERROR:  current transaction is aborted' \
     -e 'CREATE FUNCTION' -e OPERATOR


echo "GRANT ALL on geometry_columns TO osm;" | psql -Upostgres gis
echo "GRANT ALL on spatial_ref_sys TO osm;" | psql -Upostgres gis
echo "CREATE TABLE planet_osm (   osm_type    char(1),
   osm_id      bigint,   name        text,   place       text,   landuse     text,
   leisure     text,   waterway    text,   highway     text,   amenity     text,
   tourism     text,   learning    text);" | psql -Upostgres gis
echo "SELECT AddGeometryColumn('planet_osm', 'way', 4326, 'GEOMETRY', 2);" | psql -Upostgres gis
echo "ALTER TABLE planet_osm ADD CONSTRAINT pk__planet_osm PRIMARY KEY (osm_type, osm_id);" | psql -Upostgres gis
echo "CREATE INDEX planet_spatial_idx ON planet_osm USING gist (way GIST_GEOMETRY_OPS);" | psql -Upostgres gis


# ----------- As User Postgres
# Now we need the result from the osm2pgsql command
su postgres
date;time psql -Upostgres gis < $planet_name.sql >~/insert.log
# takes about 45minutes on a 2GHz machine


# ----------- as user osm:
su osm
cd
scp -r dev.openstreetmap.org:/home/artem/vmap0 ~/osm/

export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/lib

# From here on the cut'n paste part stopps

vi svn.openstreetmap.org/utils/mapnik/generate_tiles.py
vi svn.openstreetmap.org/utils/mapnik/osm.xml
and change the path to your installation:
 /home/artem/
 /home/nick/
 /data/...
 /media/disk/...

vi svn.openstreetmap.org/utils/mapnik/osm.xml
   set the host connection to your local machine:
      <Parameter name="host">/var/run/postgresql</Parameter>
      <Parameter name="type">postgis</Parameter>
      <Parameter name="port">5433</Parameter>
      <Parameter name="user">osm</Parameter>
      <Parameter name="dbname">osm</Parameter>
      <Parameter name="table">planet_osm</Parameter>


vi svn.openstreetmap.org/utils/mapnik/generate_tiles.py
    replace with your area
    bbox = (-2, 50.0,1.0,52.0)

python /home/osm/svn.openstreetmap.org/utils/mapnik/generate_tiles.py

# Upload the tiles-output to dev.openstreetmap.org or  mail a tar file to steve
rsync --size-only -r -e ssh ~/osm/tiles dev.openstreetmap.org:
